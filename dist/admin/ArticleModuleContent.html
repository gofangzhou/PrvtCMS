<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
  
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
    <title>后台管理</title>
  
    <link href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/twitter-bootstrap/5.1.3/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
  
    <link href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/layui/2.6.8/css/layui.min.css" type="text/css" rel="stylesheet" />
  
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js" type="application/javascript"></script>
  
    <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/layui/2.6.8/layui.min.js" type="application/javascript"></script>
  
      <link href="https://unpkg.com/@wangeditor/editor@latest/dist/css/style.css" rel="stylesheet" type="text/css" />
    
      <style type="text/css">
        #container_ace_editor{width:100%;height:500px;}
        </style>
    <style type="text/css">
.ms-controller{visibility:hidden;}
.hidden{display:none !important;}

html,body{min-width:1024px;}

.container-breadcrumb{background-color:#edf6fa;line-height:2.5rem;}
.container-breadcrumb .breadcrumb{margin-bottom:0;}
.breadcrumb-item b{color:#333}

.tablelist{border:solid 1px #cbcbcb; width:100%; clear:both;}
.tablelist th{background:url(/statics/admin-xxglxtjm/images/th.gif) repeat-x; height:34px; line-height:34px; border-bottom:solid 1px #b6cad2; text-indent:11px; text-align:left;padding:0;white-space:nowrap;min-width:3.5rem}
.tablelist td{line-height:35px; text-indent:11px; border-right: dotted 1px #c7c7c7;padding:0;white-space:nowrap;}
.tablelink{color:#056dae;}
.tablelist tbody tr.odd{background:#f5f8fa;}
.tablelist tbody tr:hover{background:#e5ebee;}

</style>
<style type="text/css">

</style>
<style type="text/css">

</style>
<style type="text/css">

</style>
<style type="text/css">
.col-form-label{text-align:right;}
</style>
<style type="text/css">

</style>
</head>

  <body style="min-width:1024px;">
      <div class="container-fluid container-breadcrumb">
        <div class="row">
          <div class="col">
            <nav>
              <ol class="breadcrumb">
                <li class="breadcrumb-item">
                  <b>位置</b>
                ：
                  <a href="/admin/main.html">主功能面板</a>
                </li>
              
                <li class="breadcrumb-item">
                  <a ms-attr="{href:('/admin/ArticleModule.html?type_id=' + data.type_id)}">文章管理</a>
                </li>
              
                <li class="breadcrumb-item active">{{data.title}}</li>
              </ol>
            </nav>
          </div>
        
          <!-- <div class="col-4 text-end">
                    <a href="#" class="link-primary d-inline">新增</a>
                </div> --></div>
      </div>
    
      <div class="container-fluid container-welcome mt-3">
        <div class="accordion" id="accordionExample">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                        基本信息
                    </button>
            </h2>
          
            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
              <div class="accordion-body">
                <div class="mb-3 row">
                  <label class="col-2 col-form-label">标题名称</label>
                
                  <div class="col">
                      <input type="text" class="form-control" placeholder="请填写类别名称" ms-duplex="data.title" />
                    </div>
                
</div>
              
                <div class="mb-3 row">
                  <label class="col-2 col-form-label">所属类别</label>
                
                  <div class="col">
                      <select class="form-select" ms-change="eventChangeTypeID($event)" ms-duplex="data.type_id">
                        <option value="">请选择</option>
                      
                        <option ms-attr="{value: @el_1.type_id}" ms-class="getHiddenClassByType(@el_1.type_id)" ms-for="($index_1, @el_1) in data.typeTree">{{@el_1.title}}</option>
                      </select>
                    </div>
                
</div>
              
                <div class="mb-3 row">
                  <label class="col-2 col-form-label">发布时间</label>
                
                  <div class="col">
                      <input type="text" id="publish_datetime" class="form-control" ms-duplex="data.publish_datetime" />
                    </div>
                
</div>
              
                <div class="mb-3 row" ms-class="data.view_hidden_cover_image">
                  <label class="col-2 col-form-label">封面图片</label>
                
                  <div class="col">
                      <div class="row">
                        <div class="col-xs-6 col-sm-4 col-md-3 col-lg-3" ms-for="($index_1, @el_1) in data.cover_images">
                          <div class="card" style="width: 18rem;">
                            <img ms-attr="{src: @el_1.url}" style="max-width:100%;max-height:100%;" class="card-img-top" />
                          </div>
                        </div>
                      </div>
                    
                      <p>
                        <input type="file" class="form-control" ms-change="fileChange($event, 0)" autocomplete="false" multiple="" />
                      </p>
                    </div>
                
</div>
              
                <div class="mb-3 row">
                  <label class="col-2 col-form-label">内容</label>
                
                  <div class="col">
                      <script id="container_editor" name="content" type="text/plain"></script>
                    
                      <!-- <div    id="container_wang_editor" style="border:1px solid #ddd;z-index:99999;">
                                    <div id="toolbar-container" style="border-bottom:1px solid #ddd;"></div>
                                    <div id="editor-container" style="height:500px"></div>
                                </div>
                                <div   id="container_ace_editor"></div> --></div>
                
</div>
              </div>
            </div>
          </div>
        
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingTwo">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                        其它信息
                    </button>
            </h2>
          
            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
              <div class="accordion-body">
                <div class="mb-3 row">
                  <label class="col-2 col-form-label">SEO关键词</label>
                
                  <div class="col">
                      <input type="text" class="form-control" placeholder="搜索引擎抓取的关键词" ms-duplex="data.keyword" />
                    </div>
                
</div>
              
                <div class="mb-3 row">
                  <label class="col-2 col-form-label">SEO描述</label>
                
                  <div class="col">
                      <textarea class="form-control" rows="3" placeholder="搜索引擎抓取的描述内容" ms-duplex="data.description"></textarea>
                    </div>
                
</div>
              
                <div class="mb-3 row">
                  <label class="col-2 col-form-label">启用状态</label>
                
                  <div class="col">
                      <div class="form-check form-check-inline" style="padding-top:0.4rem">
                        <input class="form-check-input" type="radio" name="show" id="inlineRadi001" value="1" ms-duplex="data.show" />
                      
                        <label class="form-check-label" for="inlineRadi001">启用</label>
                      </div>
                    
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="show" id="inlineRadi002" value="0" ms-duplex="data.show" />
                      
                        <label class="form-check-label" for="inlineRadi002">停用</label>
                      </div>
                    </div>
                
</div>
              
                <div class="mb-3 row">
                  <label class="col-2 col-form-label">首页显示</label>
                
                  <div class="col">
                      <div class="form-check form-check-inline" style="padding-top:0.4rem">
                        <input class="form-check-input" type="radio" name="show_home" id="inlineRadishow_home001" value="1" ms-duplex="data.show_home" />
                      
                        <label class="form-check-label" for="inlineRadishow_home001">启用</label>
                      </div>
                    
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="show_home" id="inlineRadishow_home002" value="0" ms-duplex="data.show_home" />
                      
                        <label class="form-check-label" for="inlineRadishow_home002">停用</label>
                      </div>
                    </div>
                
</div>
              
                <div class="mb-3 row">
                  <label class="col-2 col-form-label">外链地址</label>
                
                  <div class="col">
                      <input type="text" class="form-control" placeholder="如需要跳转到其它网站，复制链接到此处" ms-duplex="data.external_link" />
                    </div>
                
</div>
              
                <div class="mb-3 row">
                  <label class="col-2 col-form-label">封面图片地址</label>
                
                  <div class="col">
                      <input type="text" class="form-control" placeholder="已有图片访问地址，可以不用上传" ms-duplex="data.cover_image" />
                    </div>
                
</div>
              </div>
            </div>
          </div>
        </div>
      
        <div class="btn-toolbar pt-2" role="toolbar">
          <div class="d-grid gap-2 col-2">
            <button class="btn btn-primary" type="button" ms-click="eventClickSave()">保存</button>
          </div>
        </div>
      </div>
    
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js" type="application/javascript"></script>
  
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/avalon.js/2.2.7/avalon.min.js" type="application/javascript"></script>
  
    <script type="text/javascript">

    var localed = false;

    function ajax(e) {
        var t;
        if (e.url || e.success && e.success({
            state: -1,
            message: "请求链接为空！"
        }),
        !/^http/.test(e.url || "")) {
            //var i = this.apiOrigin;
            //e.url = i + e.url
        }
        var n = {};
        n["Access-Authorization"] = localStorage.getItem("Access-Authorization"),
        n.Accept = "*/*",
        e.headers = n,
        e.xhrFields = {
            withCredentials: !0
        };
        var s = e.success;
        e.success = function(e, t, i) {
            e.state - 1 && layer.msg(e.message || "服务器连接超时或服务器错误！"),
            s && s(e, t, i)
        }
        ;
        var r = e.error;
        e.error = function(e) {
            if (401 == e.status)
                return localStorage.removeItem("Access-Authorization");
            layer.msg("服务器连接超时或服务器错误！"),
            r && r(e)
        }
        ,
        $.ajax(e)
    }

    function getUrlKeyValue(name){
        return (window.location.href.match(new RegExp(`(?<=${name}=)[^\?\&]+`)) || [''])[0];
    }

    function getPort(url, callback){
        if(localed){
            callback(url);
            return;
        }
        $.ajax({
            type: "GET",
            url: "/api/server/port",
            success: function (res) {
                var origin = window.location.origin.replace(/:\d+$/,'');
                if(res && res.data){
                    callback(origin+':'+res.data+url);
                    return;
                }
                layer.alert('登录失败，请检查网络设置！');
            },
            error: function (msg) {
                localed = true;
                callback(url)
            }
        });
    }

    function getCaptcha(callBack){
        getPort('/api/captcha/create', function(url){
            ajax({
                type: "GET",
                url: url,
                success: function (res) {
                    callBack(res.children[0].outerHTML)
                }
            });
        })
    }

    function Pager() {
        return {
            page_index: 1,
            page_size: 50,
            page_count: 0,

            page_prev: 1,
            page_next: 1,
            page_total: 0,
            pages: [],
        };
    }

    function getPager(page_index, size, count) {
        const pageTotal =
        parseInt((count / size).toString()) + (count % size ? 1 : 0);

        var pager = {
        page_index: page_index,
        page_size: size,
        page_count: count,
        page_prev: page_index == 1 ? 1 : page_index - 1,
        page_next: page_index == pageTotal ? pageTotal : page_index + 1,
        page_total: pageTotal,
        };

        pager.pages = new Array(pageTotal)
        .fill(1)
        .map((key, index) => {
            return {
            page_index: index + 1,
            page_index_name: index + 1,
            page_active: "",
            };
        })
        .filter((key, index) => {
            if (index + 1 == page_index) {
            key.page_active = "active";
            return true;
            }
            if (index == 0) return true;
            if (index + 1 == pageTotal) return true;

            if (index + 4 >= page_index && index <= page_index) return true;
            if (index - 4 <= page_index && index >= page_index) return true;
            if (index + 5 == page_index || index - 5 == page_index) {
            key.page_index_name = "···";
            return true;
            }
            return false;
        });

        return pager;
    }

    function initController(settings, data) {

        // 检查控制器编号
        settings.$id || (settings.$id = `controller_${new Date().getTime()}`);

        if (settings.container) {
            layer.msg(`视图容器未设定！`);
            return;
        }

        // 获取视图
        const view = `<div ms-controller="${settings.$id}" class="${settings.$id} ${settings.class || ''}">${settings._template}</div>`;

        // 检查容器状态
        if(settings._template){
            if (settings.fillType === 'top') {
                $(settings.container || '').html(view);
            }
            else {
                $(settings.container).children().last().addClass('hidden');
                $(settings.container).append(view);
            }
        }

        settings.disabledFormControl = (dom, isCancel) => {
            if (isCancel) {
                $(dom).removeAttr('disabled');
                return;
            }
            $(dom).attr('disabled', "disabled");
        }

        avalon.config.debug = true;
        avalon.ready(() => {
            const vm = avalon.define(settings).onload(data || undefined);
            let vmTarget = $(`[ms-controller="${settings.$id}"]:eq(0)`).get(0);
            avalon.scan(vmTarget, vm, undefined);
        });
    }

    function toView(url){
        window.location.href = url;
    }
    
    function toAdminLogin(){
        toView('/admin/login.html');
    }

    function toAdminIndex(){
        toView('/admin/main.html');
    }

    function loginOut() {
        getPort('/api/user/logout', function(url){
            ajax({
                type: "post",
                url: url,
                success: function (res) {
                    localStorage.removeItem('Access-Authorization');
                    toAdminLogin();
                }
            });
        })
    }
    

    (()=>{
        const auth = localStorage.getItem('Access-Authorization');
        if(auth){
            if(/login.html/.test(window.location.href)){
                toAdminIndex();
            }
        }
        else{
            if(!/login.html/.test(window.location.href)){
                toAdminLogin();
            }
        }
    })();
    
</script>
  
      <!-- 配置文件 -->
      <script type="text/javascript" src="/statics/admin-xxglxtjm/libs/ueditor/ueditor.config.js"></script>
    
      <!-- 编辑器源码文件 -->
      <script type="text/javascript" src="/statics/admin-xxglxtjm/libs/ueditor/ueditor.all.min.js"></script>
    
      <script src="https://unpkg.com/@wangeditor/editor@latest/dist/index.js" type="text/javascript"></script>
    
      <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/ace/1.4.14/ace.min.js" type="application/javascript"></script>
    
      <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/ace/1.4.14/theme-twilight.min.js" type="application/javascript"></script>
    
      <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/ace/1.4.14/mode-javascript.min.js" type="application/javascript"></script>
    
      <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/ace/1.4.14/mode-html.min.js" type="application/javascript"></script>
    
      <script type="text/javascript">
function initArticleType(types, parent_id, space, show, selectSort, type_id) {
    selectSort = selectSort || 0;
    type_id = type_id || '';
    types.map(item => {
        if (item.parent_id == parent_id) {
            item.selectSort = selectSort++;
            item.paddingLeft = (space.length * 15) + 'px';
            if (item.type_id != type_id) {
                item.title = space + item.title;
                //item.show = show;
                initArticleType(types, item.type_id, space + '--- ', show, selectSort, type_id);
            }
            else {
                //item.show = 0;
                initArticleType(types, item.type_id, space + '--- ', 0, selectSort, type_id);
            }
        }
    })
}

function getArticleTypeAll(callback, curr_type_id){
    getPort('/api/article/getPagingArticleType', (url)=>{
        ajax({
            method: 'get',
            url: url,
            data: {
                index: 1,
                size: 1000
            },
            success: (res, state, response) => {
                if (res && res.data) {
                    const datas = JSON.parse(JSON.stringify(res.data));
                    initArticleType(datas, '', '', 1, 0, curr_type_id || '');
                    const types = datas.sort((a, b) => a.selectSort < b.selectSort ? -1 : 1);
                    callback(res.data, types);
                }
                else{
                    callback([],[]);
                }
            }
        })
    });
}
</script>
    
      <script type="text/javascript">
function getArticle(pagination, dataOption, callback){
    getPort('/api/article/getPagingArticle', (url)=>{
        
        layer.load(2, {time:10*1000});

        ajax({
            method: 'get',
            url: url,
            data: {
                index: pagination.page_index,
                size : pagination.page_size,
                type_id: dataOption.type_id,
                article_id: dataOption.article_id
            },
            success: (res, state, response) => {
                layer.closeAll();
                if (res && res.data) {

                    const pager = getPager(pagination.page_index, pagination.page_size, res.total)

                    pagination.page_count = res.total;
                    pagination.page_next = pager.page_next;
                    pagination.page_prev = pager.page_prev;
                    pagination.page_total = pager.page_total;
                    pagination.pages = [];
                    pagination.pages = pager.pages;

                    callback(res.data)                    
                }
            }
        })
    });
}
</script>
    
      <script type="text/javascript">
            (()=>{
                $('body').attr('ms-controller','root');
                $('body').addClass('ms-controller');

                // 实例化编辑器
                var g_ueditor;
                var a_ueditor;

                initController({
                    $id: 'root',
                    data: {
                        types: [],
                        typeTree:[],

                        id: '',
                        article_id: '',
                        type_id: '',
                        title: '',
                        keyword: '',
                        description: '',
                        language: 'zh-Hans',
                        show: 1,
                        content: '',
                        content_json_text: '',
                        show_home: 1,
                        cover_image: '',
                        publish_datetime: (`${new Date().getFullYear()}-0${new Date().getMonth() + 1}-0${new Date().getDay()}`).replace(/(?<=-)\d(?=\d{2})/g, '') + ' 00:00:00',
                        external_link: '',
                        original_link: '',

                        view_hidden_cover_image: 'hidden',

                        cover_images: []

                    },
                    onload: function() {
                        this.data.article_id = getUrlKeyValue('article_id');
                        this.getArticleTypeAll();
                        this.getArticle(this.data.article_id);
                        layui.laydate.render({
                            elem: '#publish_datetime',
                            type: 'datetime'
                        });
                    },
                    getArticleTypeAll: function() {
                        getArticleTypeAll((datas,dataTree)=>{
                            this.data.types = datas;
                            if(dataTree){
                                this.data.typeTree = [];
                                this.data.typeTree = dataTree.filter(p=>p.flag>0||!p.parent_id).sort((a,b)=>a.sort<b.sort?-1:1);


                                const type_id = this.data.type_id;
                                this.data.type_id = '';
                                this.data.type_id = type_id;



                            }
                        })
                    },
                    getArticleTypeName: function(type_id){
                        if(!type_id) return '';
                        return this.data.types.filter(item=>item.type_id == type_id).map(item=>{
                            const parentTitle = this.getArticleTypeName(item.parent_id);
                            return parentTitle + (parentTitle ? ' > ' : '') + item.title
                        });
                    },
                    getArticle: function(article_id){
                        if(!article_id) {
                            this.initEditor('');
                            return '';
                        }
                        this.data.article_id = article_id || '';
                        getArticle(Pager(), {article_id: this.data.article_id}, datas=>{
                            if(!datas || !datas.length){
                                layer.msg('信息不存在或已删除！');
                                return;
                            }

                            const model = datas[0];
                            Object.keys(model).map(key=>{
                                this.data[key] = model[key];
                            })

                            this.initEditor(model.content);

                            this.data.content_json_text = [this.data.content_json_text].join('').replace(/^(undefined|null|nav)$/i, '')



                            if (this.data.cover_image) {
                                this.data.cover_image = (this.data.cover_image || '');
                                this.data.cover_images = [];
                                this.data.cover_images = [{ url: this.data.cover_image }];
                            }


                            this.eventChangeTypeID({ target: { value: this.data.type_id } });

                        })
                    },
                    initEditor: function(content){
                        g_ueditor = UE.getEditor('container_editor');
                        //对编辑器的操作最好在编辑器ready之后再做
                        g_ueditor.ready(function() {
                            //设置编辑器的内容
                            g_ueditor.setContent(content);
                        });
                    },
                    initContentEditView: function(content) {
                        const that = this;

                        const editorConfig = {
                            MENU_CONF: {}
                        }

                        editorConfig.placeholder = '请输入内容'
                        editorConfig.onChange = function(editor) {
                            // 当编辑器选区、内容变化时，即触发
                            // console.log('content', editor.children)
                            // console.log('content', editor.getHtml())
                            // console.log('content', editor.getText())
                            that.data.content = editor.getHtml();
                            //that.initContentPreview();
                            
                        }


                        var headers = {};
                        headers['Access-Authorization'] = localStorage.getItem('Access-Authorization');
                        headers.Accept = '*/*';

                        editorConfig.MENU_CONF['uploadImage'] = {
                            server: '/api/upload',
                            fieldName: 'mypic',
                            maxFileSize: 1 * 1024 * 1024, // 1M
                            maxNumberOfFiles: 10,
                            llowedFileTypes: ['image/*'],
                            headers,
                            // 跨域是否传递 cookie ，默认为 false
                            withCredentials: true,
                            // 超时时间，默认为 10 秒
                            timeout: 5 * 1000, // 5 秒
                        }

                        // 创建编辑器
                        const editor = wangEditor.createEditor({
                            html: content,
                            selector: '#editor-container',
                            config: editorConfig,
                            mode: 'default',
                        })

                        // 创建工具栏
                        const toolbar = wangEditor.createToolbar({
                            editor,
                            selector: '#toolbar-container',
                            mode: 'default' // 或 'simple' 参考下文
                        })
                    },
                    fileChange(e, type) {
                        const list = (e.target).files;
                        if (list.length) {
                            const formData = new FormData();
                            for (let index = 0; index < list.length; index++) {
                                formData.append("mypic" + (index || ''), list[index]);
                            }
                            getPort('/api/upload', (url) => {
                                ajax({
                                    method: 'post',
                                    url: url,
                                    processData: false,
                                    contentType: false,
                                    data: formData,
                                    success: (res, state, response) => {

                                        if (type == "1") {

                                        }
                                        else {
                                            this.data.cover_images = [];
                                            this.data.cover_images = res.data;
                                            res.data && res.data.length && (this.data.cover_image = res.data[0].url);
                                        }
                                    }
                                })
                            })
                        }
                    },
                    eventChangeTypeID(e) {
                        const select = e.target;
                        const pmenu = this.data.types.filter(item => item.type_id == select.value);
                        this.data.view_hidden_cover_image = /(2|3|4|5)/.test(pmenu[0].flag_type) ? '' : 'hidden';
                    },
                    eventClickSave(e) {
                        e && this.disabledFormControl(e.target);
                        getPort('/api/article/addOrUpdateArticle', (url) => {
                            ajax({
                                method: 'post',
                                url: url,
                                data: {
                                    id: this.data.id,
                                    article_id: this.data.article_id,
                                    type_id: this.data.type_id,
                                    title: this.data.title,
                                    keyword: this.data.keyword,
                                    description: this.data.description,
                                    language: this.data.language || 'zh-Hans',
                                    show: this.data.show,
                                    content: g_ueditor ? g_ueditor.getContent() : a_ueditor ? a_ueditor.getValue() : this.data.content,
                                    content_json_text: '',
                                    show_home: this.data.show_home == 1 ? 1 : 0,
                                    cover_image: this.data.cover_image,
                                    publish_datetime: this.data.publish_datetime || '',
                                    external_link: this.data.external_link,
                                    original_link: this.data.original_link
                                },
                                success: (res, state, response) => {
                                    if (res.state == -1) {
                                        this.disabledFormControl(e.target, true);
                                        return;
                                    }
                                    window.location.href = '/admin/ArticleModule.html?type_id=' + this.data.type_id;
                                }
                            })
                        });
                    }
                });
            })()
        </script>
    </body>

</html>

